# Comprehensive NPM Publishing Workflow
# This workflow handles the complete release cycle from testing to publishing

name: ğŸš€ Publish to NPM

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on semantic version tags
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.0)'
        required: true
        default: ''
      dry_run:
        description: 'Dry run (test without publishing)'
        type: boolean
        default: false

env:
  NODE_VERSION: '20.x'
  PACKAGE_NAME: 'bhram-muhurat'

jobs:
  # Security and quality checks
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run security audit
        run: npm audit --audit-level moderate
        
      - name: Check for vulnerabilities
        run: |
          if npm audit --json | jq '.vulnerabilities | length' | grep -v '^0$'; then
            echo "âŒ Security vulnerabilities found"
            npm audit
            exit 1
          else
            echo "âœ… No security vulnerabilities found"
          fi

  # Complete test matrix
  test:
    name: ğŸ§ª Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [16.x, 18.x, 20.x, 22.x]
        exclude:
          # Reduce matrix size for faster CI
          - os: windows-latest
            node-version: 16.x
          - os: macos-latest
            node-version: 16.x
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run linting
        run: npm run lint
        
      - name: Run tests with coverage
        run: npm run test:coverage
        
      - name: Validate package compatibility
        run: npm run validate-deps
        
      - name: Test package installation
        run: |
          # Test if package can be imported correctly
          node -e "
            const calc = require('./src/index.js');
            console.log('âœ… Package imports successfully');
            if (typeof calc.calculate !== 'function') {
              throw new Error('Main API method not found');
            }
            console.log('âœ… Main API method available');
          "

  # Build and package verification
  build:
    name: ğŸ”¨ Build & Package
    needs: [security, test]
    runs-on: ubuntu-latest
    outputs:
      package-version: ${{ steps.version.outputs.version }}
      tag-version: ${{ steps.version.outputs.tag }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Extract version information
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            TAG="v${VERSION}"
          else
            TAG="${GITHUB_REF#refs/tags/}"
            VERSION="${TAG#v}"
          fi
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"
          echo "Tag: ${TAG}"
          
      - name: Verify version consistency
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          EXPECTED_VERSION="${{ steps.version.outputs.version }}"
          
          if [ "$PACKAGE_VERSION" != "$EXPECTED_VERSION" ]; then
            echo "âŒ Version mismatch!"
            echo "Package.json: $PACKAGE_VERSION"
            echo "Expected: $EXPECTED_VERSION"
            echo "Please update package.json version before creating the tag"
            exit 1
          fi
          echo "âœ… Version verification passed: $PACKAGE_VERSION"
          
      - name: Build package
        run: npm run build
        
      - name: Create package tarball
        run: |
          npm pack
          ls -la *.tgz
          
      - name: Verify package contents
        run: |
          TARBALL=$(ls *.tgz)
          echo "ğŸ“¦ Package contents:"
          tar -tzf "$TARBALL" | head -20
          
          # Verify essential files are included
          if ! tar -tzf "$TARBALL" | grep -q "package/src/index.js"; then
            echo "âŒ Main file missing from package"
            exit 1
          fi
          
          if ! tar -tzf "$TARBALL" | grep -q "package/package.json"; then
            echo "âŒ package.json missing from package"
            exit 1
          fi
          
          echo "âœ… Package verification passed"

  # Generate release notes
  release:
    name: ğŸ“ Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog
          
      - name: Generate detailed changelog
        id: changelog
        run: |
          # Get previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          CURRENT_TAG="${{ needs.build.outputs.tag-version }}"
          
          echo "Generating changelog from $PREVIOUS_TAG to $CURRENT_TAG"
          
          # Get commits since last tag
          if [ -z "$PREVIOUS_TAG" ]; then
            COMMITS=$(git log --pretty=format:"* %s (%h)" --no-merges)
          else
            COMMITS=$(git log $PREVIOUS_TAG..HEAD --pretty=format:"* %s (%h)" --no-merges)
          fi
          
          # Create comprehensive changelog
          CHANGELOG="## ğŸ‰ What's New in $CURRENT_TAG
          
          ### ğŸ“‹ Changes
          $COMMITS
          
          ### ğŸ”§ Technical Details
          - **Node.js Support**: 16.x, 18.x, 20.x, 22.x
          - **Platforms**: Linux, Windows, macOS  
          - **Package Size**: $(du -h *.tgz 2>/dev/null | cut -f1 || echo 'N/A')
          
          ### ğŸ“¦ Installation
          \`\`\`bash
          npm install ${{ env.PACKAGE_NAME }}@${{ needs.build.outputs.package-version }}
          \`\`\`
          
          ### ğŸ”— Links
          - **NPM Package**: https://www.npmjs.com/package/${{ env.PACKAGE_NAME }}
          - **Documentation**: https://github.com/rakshitbharat/bhram-muhurat#readme
          - **Issues**: https://github.com/rakshitbharat/bhram-muhurat/issues"
          
          if [ -n "$PREVIOUS_TAG" ]; then
            CHANGELOG="$CHANGELOG
          - **Full Changelog**: https://github.com/rakshitbharat/bhram-muhurat/compare/$PREVIOUS_TAG...$CURRENT_TAG"
          fi
          
          # Save to file and output
          echo "$CHANGELOG" > RELEASE_NOTES.md
          echo 'CHANGELOG<<EOF' >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build.outputs.tag-version }}
          name: 'ğŸš€ Release ${{ needs.build.outputs.tag-version }}'
          body: ${{ steps.changelog.outputs.CHANGELOG }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            *.tgz
            RELEASE_NOTES.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # NPM Publishing with comprehensive checks
  publish:
    name: ğŸ“¦ Publish to NPM
    needs: [build, release]
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js with NPM registry
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org/'
          
      - name: Verify NPM token
        run: |
          if [ -z "${{ secrets.NPM_TOKEN }}" ]; then
            echo "âŒ NPM_TOKEN secret is not set"
            echo "Please add your NPM automation token to GitHub Secrets"
            exit 1
          fi
          echo "âœ… NPM token is configured"
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build package
        run: npm run build
        
      - name: Final test run
        run: npm test
        
      - name: Check if version already published
        id: check_published
        run: |
          PACKAGE_VERSION="${{ needs.build.outputs.package-version }}"
          
          if npm view ${{ env.PACKAGE_NAME }}@$PACKAGE_VERSION version 2>/dev/null; then
            echo "ALREADY_PUBLISHED=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Version $PACKAGE_VERSION is already published to NPM"
          else
            echo "ALREADY_PUBLISHED=false" >> $GITHUB_OUTPUT
            echo "âœ… Version $PACKAGE_VERSION is ready to be published"
          fi
          
      - name: Dry run publish
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "ğŸ§ª Performing dry run..."
          npm publish --dry-run --access public
          echo "âœ… Dry run completed successfully"
          
      - name: Publish to NPM
        if: steps.check_published.outputs.ALREADY_PUBLISHED == 'false' && github.event.inputs.dry_run != 'true'
        run: |
          echo "ğŸ“¦ Publishing to NPM..."
          npm publish --access public
          echo "âœ… Package published successfully!"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          
      - name: Verify publication
        if: steps.check_published.outputs.ALREADY_PUBLISHED == 'false' && github.event.inputs.dry_run != 'true'
        run: |
          PACKAGE_VERSION="${{ needs.build.outputs.package-version }}"
          
          echo "â³ Waiting for NPM registry to update..."
          sleep 30
          
          # Retry mechanism for verification
          for i in {1..5}; do
            if npm view ${{ env.PACKAGE_NAME }}@$PACKAGE_VERSION version; then
              echo "âœ… Package successfully published and verified!"
              echo ""
              echo "ğŸ‰ Success! Your package is now available:"
              echo "ğŸ“¦ Install: npm install ${{ env.PACKAGE_NAME }}@$PACKAGE_VERSION"
              echo "ğŸŒ NPM: https://www.npmjs.com/package/${{ env.PACKAGE_NAME }}"
              echo "ğŸ“š Docs: https://github.com/rakshitbharat/bhram-muhurat#readme"
              exit 0
            else
              echo "â³ Attempt $i/5: Package not yet available, waiting..."
              sleep 15
            fi
          done
          
          echo "âŒ Failed to verify package publication after 5 attempts"
          echo "The package may still be processing. Check NPM directly:"
          echo "https://www.npmjs.com/package/${{ env.PACKAGE_NAME }}"
          exit 1
          
      - name: Post-publish summary
        if: always()
        run: |
          echo "## ğŸ“Š Publish Summary"
          echo "- **Package**: ${{ env.PACKAGE_NAME }}"
          echo "- **Version**: ${{ needs.build.outputs.package-version }}"
          echo "- **Tag**: ${{ needs.build.outputs.tag-version }}"
          echo "- **Dry Run**: ${{ github.event.inputs.dry_run || 'false' }}"
          echo "- **Already Published**: ${{ steps.check_published.outputs.ALREADY_PUBLISHED || 'false' }}"
          
          if [ "${{ steps.check_published.outputs.ALREADY_PUBLISHED }}" == "false" ] && [ "${{ github.event.inputs.dry_run }}" != "true" ]; then
            echo "- **Status**: âœ… Successfully published"
          elif [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "- **Status**: ğŸ§ª Dry run completed"
          else
            echo "- **Status**: âš ï¸ Already published"
          fi

  # Notify on completion
  notify:
    name: ğŸ“¢ Notify Completion
    needs: [publish]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Success notification
        if: needs.publish.result == 'success'
        run: |
          echo "ğŸ‰ RELEASE COMPLETED SUCCESSFULLY!"
          echo ""
          echo "âœ… All checks passed"
          echo "âœ… Package published to NPM"
          echo "âœ… GitHub release created"
          echo ""
          echo "ğŸ“¦ Package: https://www.npmjs.com/package/${{ env.PACKAGE_NAME }}"
          echo "ğŸš€ Release: https://github.com/rakshitbharat/bhram-muhurat/releases"
          
      - name: Failure notification
        if: needs.publish.result == 'failure'
        run: |
          echo "âŒ RELEASE FAILED!"
          echo ""
          echo "Please check the workflow logs for details:"
          echo "https://github.com/rakshitbharat/bhram-muhurat/actions"
          exit 1
